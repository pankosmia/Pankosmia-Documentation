name: Preview deploy (use main workflow)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Use workflow from Branch:main only above. Enter branch, tag, PR ref, or commit to build below:'
        required: true
        default: ''

permissions:
  contents: write

concurrency:
  group: "pages-preview"
  cancel-in-progress: false

jobs:
  build-preview:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    outputs:
      preview_ref: ${{ steps.set-ref.outputs.preview_ref }}
      base_path: ${{ steps.set-ref.outputs.base_path }}
    steps:
      - name: Determine ref to build
        id: set-ref
        run: |
          REF="${{ github.event.inputs.ref }}"
          REF="${REF#refs/heads/}"
          # Normalize: collapse duplicate slashes, remove leading/trailing slashes
          REF="$(echo "$REF" | sed -E 's#/{2,}#/#g' | sed -E 's#^/##; s#/$##')"
          BASE_PATH="/previews/${REF}"
          echo "preview_ref=${REF}" >> $GITHUB_OUTPUT
          echo "base_path=${BASE_PATH}" >> $GITHUB_OUTPUT

      - name: Checkout target ref
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.set-ref.outputs.preview_ref }}
          fetch-depth: 0

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.6'
          bundler-cache: true
          cache-version: 0

      - name: Build preview with Jekyll
        env:
          JEKYLL_ENV: production
        run: |
          bundle exec jekyll build \
            --baseurl "${{ steps.set-ref.outputs.base_path }}" \
            --destination ./_site

      - name: Upload built preview
        uses: actions/upload-artifact@v4
        with:
          name: preview-site
          path: ./_site

  publish-preview:
    needs: build-preview
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Download built preview
        uses: actions/download-artifact@v4
        with:
          name: preview-site
          path: preview-temp

      - name: Copy preview into previews/<ref> on main
        run: |
          REF="${{ needs.build-preview.outputs.preview_ref }}"
          # target path in repo
          TARGET_DIR="previews/${REF}"

          mkdir -p "$(dirname "${TARGET_DIR}")"

          # Remove any existing preview for this ref
          rm -rf "${TARGET_DIR}"

          # Copy built site
          cp -R "preview-temp/." "${TARGET_DIR}"

      - name: Commit and push preview
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "previews/${{ needs.build-preview.outputs.preview_ref }}"

          if git diff --cached --quiet; then
            echo "No changes to commit for preview."
            exit 0
          fi

          git commit -m "ci: add preview for ${{ needs.build-preview.outputs.preview_ref }}"
          git push origin main

      - name: Output preview URL
        run: |
          echo "Preview deployed at: https://pankosmia.dev${{ needs.build-preview.outputs.base_path }}"
