name: Preview deploy

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Optional: branch, tag, PR ref, or commit to build (leave empty to use branch selected in Run workflow dialog)'
        required: false
        default: ''

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages-preview"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      preview_ref: ${{ steps.set-ref.outputs.preview_ref }}
      base_path: ${{ steps.set-ref.outputs.base_path }}
    steps:
      - name: Determine ref to build
        id: set-ref
        run: |
          # Use input ref if provided, otherwise use the branch selected in UI
          if [ -n "${{ github.event.inputs.ref }}" ]; then
            REF="${{ github.event.inputs.ref }}"
          else
            REF="${{ github.ref_name }}"
          fi
          # Strip optional refs/heads/ prefix
          REF="${REF#refs/heads/}"
          # Sanitize for a URL path but preserve internal slashes so previews appear under /previews/branch/name
          # Replace any leading/trailing slashes and collapse multiple slashes
          REF="${REF#"${REF%%[!/]*/}"}"
          REF="$(echo "$REF" | sed -E 's#/{2,}#/#g' | sed -E 's#^/##; s#/$##')"
          # Provide a base_path for Jekyll so the preview appears at /previews/<REF>
          BASE_PATH="/previews/${REF}"
          echo "preview_ref=${REF}" >> $GITHUB_OUTPUT
          echo "base_path=${BASE_PATH}" >> $GITHUB_OUTPUT

      - name: Checkout target ref
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.set-ref.outputs.preview_ref }}
          fetch-depth: 0

      - name: Setup Ruby
        uses: ruby/setup-ruby@4a9ddd6f338a97768b8006bf671dfbad383215f4
        with:
          ruby-version: '3.3.6'
          bundler-cache: true
          cache-version: 0

      - name: Build with Jekyll
        env:
          JEKYLL_ENV: production
        run: |
          # Build Jekyll into ./_site and set baseurl so Pages serves under /previews/<ref>
          bundle exec jekyll build --baseurl "${{ steps.set-ref.outputs.base_path }}" --destination ./_site

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Output preview URL
        run: |
          echo "Preview deployed at: ${{ steps.deployment.outputs.page_url }}${{ needs.build.outputs.base_path }}"
